# format

continuous-dataframe-stream format v0.1.0

## 概要

このファイルは、continuous-dataframe-stream のフォーマットの定義を行います。  

## 用語

- cdfs  
  continuous-dataframe-srteam の略。  
- フレーム  
  cdfsが保持するデータの最小単位。  
- シーケンス  
  cdfs内の連続するフレームに順に割り当てられる一意の番号。

## ファイル拡張子

プレーンなcdfsのファイル拡張子は基本`.cdfs`とします。  
特別なデータを格納したcdfsに対して異なる拡張子を割り当てても良いです。  

## データ構造

cdfsのデータは256バイトのフレームを順に連結したものです。  

書き込む際のバイト順序はリトルエンディアンを推奨しますが、どちらでも良いです。  
読み込む際はフレームの種類のバイト順序を使用します。  
リトルエンディアンでの実装は必須ですが、ビッグエンディアンでの実装は任意です。  

### フレーム基本構造

256バイトのデータグラムをひとつのフレームとして扱います。  

|データ位置|メンバ名 |サイズ|説明
|---------:|---------|------|----
|      0x00|sequence |8     |フレームのシーケンス
|      0x08|frameType|4     |フレームの種類
|      0x0C|data     |240   |フレームの内容
|      0xFC|checksum |4     |データのチェックサム

- sequence (uint64)  
  フレームのシーケンスの下位64ビットを格納します。  
  前後のフレームと順序関係が保たれている必要があります。  
- frameType (uint32)  
  フレームの種類を格納します。  
  フレームの種類は後述のとおりです。  
  記述にない種類のフレームに遭遇した場合、警告を発するかエラー停止するかのどちらかを選択できます。
- data (uint8[])  
  実際の内容となるデータを格納します。  
  データが格納されていない領域はすべて`0x00`でフィルします。  
- checksum (uint32)  
  フレームのCRCチェックサムを格納します。  
  計算範囲はフレームの最初から`data`の最後まで(`0x00-0xFB`)です。  
  チェックサムの書き込み・読み込み時のチェックはともに必須です。  

### フレーム構造(開始フレーム)

開始フレームは`frameType`がascii文字列`'CDFS'`となるフレームです。  
このフレームはcdfsの最初に正確に1つ必要です。  

|データ位置|メンバ名    |サイズ|説明
|---------:|------------|------|----
|      0x00|sequence    |8     |フレームのシーケンス(=`0`)
|      0x08|frameType   |4     |フレームの種類(=`'CDFS'`)
|      0x0C|data        |240   |フレームの内容
|      0x0C|data.version|4     |フォーマットバージョン
|      0x10|data.count  |16    |総フレーム数
|      0x20|data.label  |32    |ラベル
|      0x40|data.size   |16    |内容のサイズ
|      0x50|            |172   |(予約済み)
|      0xFC|checksum    |4     |データのチェックサム

- data.version (uint32)  
  cdfsフォーマットのバージョン。  
  `0x00XXYYZZ`のとき、メジャーバージョン0xXX、マイナーバージョン0xYY、パッチバージョン0xZZです。  
- data.count (uint128)  
  このcdfsに含まれるすべてのフレームの総数。  
  終了フレームの`data.count`と同じか、`0`である必要があります。  
- data.label (char[])  
  このcdfsに割り当てられたラベル。  
  `null`終端のUTF-8文字列です。  
- data.size (uint128)  
  このcdfsが持つ内容のバイト単位のサイズ。  
  終了フレームの`data.size`と同じか、`0`である必要があります。  

### フレーム構造(終了フレーム)

終了フレームは`frameType`がascii文字列`'FINF'`となるフレームです。  
このフレームはcdfsの最後に正確に1つ必要です。  

|データ位置|メンバ名  |サイズ|説明
|---------:|----------|------|----
|      0x00|sequence  |8     |フレームのシーケンス
|      0x08|frameType |4     |フレームの種類(=`'FINF'`)
|      0x0C|data      |240   |フレームの内容
|      0x0C|          |4     |(予約済み)
|      0x10|data.count|16    |総フレーム数
|      0x20|data.hash |32    |内容のチェックサム
|      0x40|data.size |16    |内容のサイズ
|      0x50|          |172   |(予約済み)
|      0xFC|checksum  |4     |データのチェックサム

- data.count (uint128)  
  このcdfsに含まれるすべてのフレームの総数。  
  開始フレームの`data.count`とは異なり、このメンバは必須です。  
- data.hash (uint8[])  
  cdfsが持つ内容のチェックサム。  
  現在チェックサムを指定する方法がないため現在予約済みです。  
- data.size (uint128)  
  このcdfsが持つ内容のバイト単位のサイズ。  
  開始フレームの`data.count`とは異なり、このメンバは必須です。  

### フレーム構造(データフレーム)

データフレームは`frameType`がascii文字列`'DATA'`となるフレームです。  
このフレームはcdfsの開始フレームから終了フレームの間に0個以上置くことができます。  

|データ位置|メンバ名 |サイズ|説明
|---------:|---------|------|----
|      0x00|sequence |8     |フレームのシーケンス
|      0x08|frameType|4     |フレームの種類(=`'DATA'`)
|      0x0C|data     |240   |フレームの内容
|      0xFC|checksum |4     |データのチェックサム

- data (uint8[])  
  実際の内容となるデータを格納します。  
  データが格納されていない領域はすべて`0x00`でフィルします。  
  cdfs中の最後のデータフレームを除き、すべてのデータフレームは240バイトすべてを埋める必要があります。  
  すべてのデータフレームに格納されたデータの合計サイズは`data.size`と同じである必要があります。  

### フレーム構造(継続フレーム)

データフレームは`frameType`がascii文字列`'CONT'`となるフレームです。  
このフレームはcdfsの開始フレームから終了フレームの間に0個以上置くことができます。  

|データ位置|メンバ名    |サイズ|説明
|---------:|------------|------|----
|      0x00|sequence    |8     |フレームのシーケンス
|      0x08|frameType   |4     |フレームの種類(=`'CONT'`)
|      0x0C|data        |240   |フレームの内容
|      0x0C|            |4     |(予約済み)
|      0x10|data.current|16    |フレーム数
|      0x20|data.hash   |32    |内容のチェックサム
|      0x40|            |188   |(予約済み)
|      0xFC|checksum    |4     |データのチェックサム

- data.current (uint128)  
  現在のフレームのシーケンス。  
- data.hash (uint8[])  
  現在のフレームまでのcdfsの内容のチェックサム。  
  現在チェックサムを指定する方法がないため現在予約済みです。  

### フレーム構造(メタデータフレーム)
