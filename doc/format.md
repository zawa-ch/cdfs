# format

continuous-dataframe-stream format v0.2.0

## 概要

このファイルは、continuous-dataframe-stream のフォーマットの定義を行います。  

## 用語

- cdfs  
  continuous-dataframe-srteam の略。  
- フレーム  
  cdfsが保持するデータの最小単位。  
- シーケンス  
  cdfs内の連続するフレームに0から順に割り当てられる一意の番号。
- ストリーム  
  cdfs内で割り当てられる独立したデータストリーム。  
- メタデータ  
  cdfsストリームに対して付与される追加情報。  

この文書における次の各キーワード「しなければならない（ MUST ）」、
「してはならない（ MUST NOT ）」、「要求されている（ REQUIRED ）」、
「することになる（ SHALL ）」、「することはない（ SHALL NOT ）」、
「する必要がある（ SHOULD ）」、「しないほうがよい（ SHOULD NOT ）」、
「推奨される（ RECOMMENDED ）」、「してもよい（ MAY ）」、
「選択できる（ OPTIONAL ）」は、[RFC 2119](https://tools.ietf.org/html/rfc2119)
で述べられているように 解釈されるべきものです。 

## データ構造

cdfsのデータは256バイトのフレームを順に連結したものです。  

書き込む際のバイト順序はリトルエンディアン、ビッグエンディアンのいずれかを選択できます(OPTIONAL)。  
読み込む際はフレームの種類のバイト順序を使用します。  
リトルエンディアンでの実装が要求されています(REQUIRED)が、ビッグエンディアンでの実装は任意(MAY)です。  

### フレーム基本構造

256バイトのデータグラムをひとつのフレームとして扱います。  

|データ位置|メンバ名 |サイズ|説明
|---------:|---------|------|----
|      0x00|sequence |4     |フレームのシーケンス
|      0x04|frameType|4     |フレームの種類
|      0x08|data     |244   |フレームの内容
|      0xFC|checksum |4     |データのチェックサム

- sequence (uint32)  
  フレームのシーケンスの下位32ビットを格納します。  
  前後のフレームと順序関係が保たれていなくてはなりません(MUST)。  
- frameType (uint32)  
  フレームの種類を格納します。  
  フレームの種類は後述のとおりです。  
  記述にない種類のフレームに遭遇した場合、警告を発するかエラー停止するかのどちらかを選択できます(OPTIONAL)。  
- data (uint8[])  
  実際の内容となるデータを格納します。  
  データが格納されていない領域はすべて`0x00`でフィルする必要があります(SHOULD)。  
- checksum (uint32)  
  フレームのCRCチェックサムを格納します。  
  計算範囲はフレームの最初から`data`の最後まで(`0x00-0xFB`)です。  
  チェックサムの書き込み・読み込み時のチェックはともに行わなくてはなりません(MUST)。  

### フレーム構造(開始フレーム)

開始フレームは`frameType`が`0x43444653`(=ascii文字列`'CDFS'`)となるフレームで、
CDFSデータの開始を示すフレームです。  
このフレームはcdfsの最初に正確に1つ置く必要があります(SHOULD)。  

|データ位置|メンバ名    |サイズ|説明
|---------:|------------|------|----
|      0x00|sequence    |4     |フレームのシーケンス(=`0`)
|      0x04|frameType   |4     |フレームの種類(=`'CDFS'`)
|      0x08|data        |244   |フレームの内容
|      0x08|data.version|4     |フォーマットバージョン
|      0x0C|            |4     |(予約済み)
|      0x10|data.count  |16    |総フレーム数
|      0x20|data.label  |32    |ラベル
|      0x40|data.size   |16    |すべてのストリームの合計サイズ
|      0x50|            |172   |(予約済み)
|      0xFC|checksum    |4     |データのチェックサム

- data.version (uint32)  
  cdfsフォーマットのバージョン。  
  `0x00XXYYZZ`のとき、メジャーバージョン0xXX、マイナーバージョン0xYY、パッチバージョン0xZZです。  
  ライブラリはこの情報をもとにこのCDFSデータが読み込み可能であるかを判別する必要があります(SHOULD)。  
- data.count (uint128)  
  このcdfsに含まれるすべてのフレームの総数。  
  終了フレームの`data.count`と同じか、`0`である必要があります(SHOULD)。  
- data.label (char[])  
  このcdfsに割り当てられたラベル。  
  `null(=/0)`終端のUTF-8文字列です。  
  データ領域すべてを使用してもよいです(MAY)。その場合は`null(=/0)`で終了する必要はありません。  
  また、このメンバが空であってもよいです(MAY)。その場合はこのメンバ全体が`null(=/0)`で埋められている必要があります(SHOULD)。  
- data.size (uint128)  
  このcdfsが持つすべてのストリームのバイト単位のサイズ。  
  終了フレームの`data.size`と同じか、`0`である必要があります(SHOULD)。  

### フレーム構造(終了フレーム)

終了フレームは`frameType`が`0x46494E46`(=ascii文字列`'FINF'`)となるフレームで、
CDFSデータの終了を示すフレームです。  
このフレームはcdfsの最後に正確に1つ置く必要があります(SHOULD)。  

|データ位置|メンバ名  |サイズ|説明
|---------:|----------|------|----
|      0x00|sequence  |4     |フレームのシーケンス
|      0x04|frameType |4     |フレームの種類(=`'FINF'`)
|      0x08|data      |244   |フレームの内容
|      0x08|          |8     |(予約済み)
|      0x10|data.count|16    |総フレーム数
|      0x20|data.label|32    |ラベル
|      0x40|data.size |16    |ストリームのサイズ
|      0x50|          |172   |(予約済み)
|      0xFC|checksum  |4     |データのチェックサム

- data.count (uint128)  
  このcdfsに含まれるすべてのフレームの総数。  
  必ず自身を含むすべてのフレーム数を記述しなくてはなりません(MUST)。  
- data.label (char[])  
  このcdfsに割り当てられたラベル。  
  `null(=/0)`終端のUTF-8文字列です。  
  開始フレームの`data.label`と同じでなくてはなりません(MUST)。  
- data.size (uint128)  
  このcdfsが持つ内容のバイト単位のサイズ。  
  必ずすべてのCDFSデータの総サイズを記述しなくてはなりません(MUST)。  

### フレーム構造(データフレーム)

データフレームは`frameType`が`0x44415444`(=ascii文字列`'DATA'`)となるフレームで、
実際のCDFSストリームのデータを含めるためのフレームです。  
このフレームはcdfsの開始フレームから終了フレームの間に0個以上置くことができます(MAY)。  
空のデータフレームをCDFSデータ中に置いてもよい(MAY)ですが、しないほうがよいです(SHOULD NOT)。  

|データ位置|メンバ名     |サイズ|説明
|---------:|-------------|------|----
|      0x00|sequence     |4     |フレームのシーケンス
|      0x04|frameType    |4     |フレームの種類(=`'DATA'`)
|      0x08|data         |244   |フレームの内容
|      0x08|data.streamID|2     |ストリーム番号
|      0x0A|             |1     |(予約済み)
|      0x0B|data.size    |1     |内容のサイズ
|      0x0C|data.content |240   |内容となるストリーム
|      0xFC|checksum     |4     |データのチェックサム

- data.streamID (uint16)  
  このフレームのデータがどのストリームのデータであるかを示します。  
- data.size (uint8)  
  このフレームに含まれるデータの大きさを示します。  
  `0`以上`240`以下でなくてはなりません(MUST)。  
- data.content (uint8[])  
  実際の内容となるデータを格納します。  
  データが格納されていない領域はすべて`0x00`でフィルしなくてはなりません(MUST)。  
  `data.size`で指定された領域までが格納できるデータの範囲になります(SHALL)。  

### フレーム構造(継続フレーム)

データフレームは`frameType`が`0x434F4E54`(=ascii文字列`'CONT'`)となるフレームで、
データが継続していることを示し、同期などのための追加情報を含めるためのフレームです。  
このフレームはcdfsの開始フレームから終了フレームの間に0個以上置くことができます(MAY)。  

|データ位置|メンバ名    |サイズ|説明
|---------:|------------|------|----
|      0x00|sequence    |4     |フレームのシーケンス
|      0x04|frameType   |4     |フレームの種類(=`'CONT'`)
|      0x08|data        |244   |フレームの内容
|      0x08|            |8     |(予約済み)
|      0x10|data.current|16    |フレーム数
|      0x20|data.label  |32    |ラベル
|      0x40|            |188   |(予約済み)
|      0xFC|checksum    |4     |データのチェックサム

- data.current (uint128)  
  現在のフレームのシーケンス。  
- data.label (char[])  
  このcdfsに割り当てられたラベル。  
  `null`終端のUTF-8文字列です。  
  開始フレームの`data.label`と同じでなくてはなりません(MUST)。  

### フレーム構造(メタデータフレーム)

データフレームは`frameType`が`0x4D455441`(=ascii文字列`'META'`)となるフレームで、
CDFSストリームに付加する追加情報を含めるためのフレームです。  
このフレームはcdfsの開始フレームから終了フレームの間に0個以上置くことができます(MAY)。  

|データ位置|メンバ名    |サイズ|説明
|---------:|------------|------|----
|      0x00|sequence    |4     |フレームのシーケンス
|      0x04|frameType   |4     |フレームの種類(=`'META'`)
|      0x08|data        |244   |フレームの内容
|      0x08|data.flags  |2     |オプションフラグ
|      0x0A|            |1     |(予約済み)
|      0x0B|data.size   |1     |内容のサイズ
|      0x0C|data.content|240   |内容
|      0xFC|checksum    |4     |データのチェックサム

- data.flags (bitset)  
  このフレームに付加されるオプションフラグ。  
  - \[0\]: continue (bool)  
    このフレームの情報が直前のフレームから継続して送られているか。  
    継続データの場合は`true`(=`1`)、そうでない場合は`false`(=`0`)になります。  
- data.size (uint8)  
  このフレームに含まれるデータの大きさを示します。  
  `0`以上`240`以下でなくてはなりません(MUST)。  
- data.content (uint8[])  
  実際の内容となるデータを格納します。  
  データが格納されていない領域はすべて`0x00`でフィルしなくてはなりません(MUST)。  
  `data.size`で指定された領域までが格納できるデータの範囲になります(SHALL)。  

## CDFSストリーム仕様

CDFSストリームは0バイト以上のビット列です。  
CDFSでは65536個までのストリームに対応しています。  
各ストリームに128ビットのアドレス空間が割り当てられており、それぞれの空間は独立しています。  
データはバイト(=8ビット)単位でアラインされ、アドレスもバイト単位となります。  

各ストリームに書き込み可能な最大サイズは`2^128 - 1`バイトで、ストリーム全体で書き込み可能な最大サイズも`2^128 - 1`バイトです。  

ストリームに対して追記およびシークを実装してもよい(MAY)ですが、アドレスからフレーム位置を推定することはできないためランダムアクセスをすることはありません(SHALL NOT)。  

## CDFSメタデータ仕様

(未策定)

## ファイル記述仕様

ファイルにCDFSデータを記述する場合はファイルのすべてがCDFSデータでなくてはなりません(MUST)。  
また、CDFSフレームはファイルストリーム全体にわたって256バイトでアライメントされている必要があります(SHOULD)。
フレーム間に余分なデータおよびパディングを含めてはなりません(MUST NOT)。  
テープ等への書き込みにあたってアライメント要件を満たすために必要な場合、CDFSデータの前後にパディングを含めてもよいです(MAY)。
その場合、どの位置からCDFSデータが開始するのかが明確に判別できるようになっている必要があります(SHOULD)。  

### ファイル拡張子

プレーンなcdfsのファイル拡張子は基本`.cdfs`とします。  
特別なデータを格納したcdfsに対して異なる拡張子を割り当ててもよいです(MAY)。  

## 伝送時の仕様

データは必ずCDFSフレーム単位で伝送しなくてはなりません(MUST)。  
